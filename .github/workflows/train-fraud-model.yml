name: Train and Deploy Fraud Detection Model

on:
  schedule:
    - cron: '0 2 1 * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'analytics/**'
      - '.github/workflows/train-fraud-model.yml'

env:
  PYTHON_VERSION: '3.12'
  MODEL_OUTPUT_PATH: 'analytics/Fraud_Detection/fraud_detection_model.pkl'
  AZURE_STORAGE_ACCOUNT: 'awardnominationmodels'
  BLOB_CONTAINER: 'ml-models'
  BLOB_NAME: 'fraud_detection_model.pkl'

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd analytics
        if [ -f requirements.txt ]; then
          echo "ðŸ“¦ Installing from requirements.txt..."
          pip install -r requirements.txt
        else
          echo "âš ï¸ No requirements.txt found, installing default packages..."
          pip install pandas numpy scikit-learn matplotlib seaborn pyodbc python-dotenv azure-storage-blob azure-identity
        fi
      
    - name: ðŸ”§ Install Microsoft ODBC Driver 18 for SQL Server
      run: |
        sudo apt-get update
        # Add Microsoft repo key and list (adapt for exact Ubuntu version if needed)
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        # Accept EULA and install driver + optional tools
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
        # Optional but recommended: unixODBC dev headers (helps pyodbc compile if needed, though usually not)
        sudo apt-get install -y unixodbc-dev
        # Verify installation (debug only, can remove later)
        odbcinst -q -d
        # Should show: [ODBC Driver 18 for SQL Server]
    
    - name: ðŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ðŸ¤– Train Fraud Detection Model
      env:
        SQL_SERVER: ${{ secrets.SQL_SERVER }}
        SQL_DATABASE: ${{ secrets.SQL_DATABASE }}
        SQL_USER: ${{ secrets.SQL_USER }}
        SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
      run: |
        cd analytics/Fraud_Detection
        echo "ðŸš€ Starting fraud model training..."
        python train_fraud_model.py
        
        if [ -f "fraud_detection_model.pkl" ]; then
          echo "âœ… Model trained successfully"
          ls -lh fraud_detection_model.pkl
        else
          echo "âŒ Model file not found!"
          exit 1
        fi
    
    - name: â˜ï¸ Upload Model to Azure Blob Storage
      run: |
        echo "ðŸ“¤ Uploading model to Azure Blob Storage..."
        az storage blob upload \
          --account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
          --container-name ${{ env.BLOB_CONTAINER }} \
          --name ${{ env.BLOB_NAME }} \
          --file ${{ env.MODEL_OUTPUT_PATH }} \
          --overwrite \
          --auth-mode login
        
        echo "âœ… Model uploaded successfully"
        
        az storage blob show \
          --account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
          --container-name ${{ env.BLOB_CONTAINER }} \
          --name ${{ env.BLOB_NAME }} \
          --query "{name: name, size: properties.contentLength, lastModified: properties.lastModified}" \
          --output table
    
    - name: ðŸ“Š Upload Training Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: fraud-model-artifacts
        path: |
          analytics/Fraud_Detection/fraud_detection_model.pkl
          analytics/Fraud_Detection/fraud_detection_analysis.png
        retention-days: 30
    
    - name: ðŸ“ Create Deployment Summary
      if: success()
      run: |
        echo "### ðŸŽ‰ Fraud Model Training Complete! ðŸ¤–" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Training Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Model Location:** Azure Blob Storage" >> $GITHUB_STEP_SUMMARY
        echo "**Storage Account:** ${{ env.AZURE_STORAGE_ACCOUNT }}" >> $GITHUB_STEP_SUMMARY
        echo "**Container:** ${{ env.BLOB_CONTAINER }}" >> $GITHUB_STEP_SUMMARY
        echo "**Blob:** ${{ env.BLOB_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Model is now available for Container Apps" >> $GITHUB_STEP_SUMMARY