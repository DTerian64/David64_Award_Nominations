name: Deploy Backend to Azure Container Apps

on:
  push:
    branches:
      - main  # Trigger on push to main branch
    paths:
      - 'backend/**'  # Only trigger if backend files change
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:  # Allow manual trigger from GitHub UI

env:
  ACR_NAME: acrawardnomination
  ACR_LOGIN_SERVER: acrawardnomination.azurecr.io
  IMAGE_NAME: award-nomination-api
  RESOURCE_GROUP: rg_award_nomination
  CONTAINER_APP_EASTUS: award-api-eastus
  CONTAINER_APP_WESTUS: award-api-westus

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build Docker image
      run: |
        cd backend
        docker build -t ${{ env.IMAGE_NAME }}:latest .
        docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
        docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Push to Azure Container Registry
      run: |
        docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Set Container App Secrets
      run: |
        # Get ACR admin password to inject as registry secret
        ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)

        for APP in ${{ env.CONTAINER_APP_EASTUS }} ${{ env.CONTAINER_APP_WESTUS }}; do
          az containerapp secret set \
            --name $APP \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --secrets \
              "gmail-app-password=${{ secrets.GMAIL_APP_PASSWORD }}" \
              "sql-database=${{ secrets.SQL_DATABASE }}" \
              "sql-password=${{ secrets.SQL_PASSWORD }}" \
              "sql-server=${{ secrets.SQL_SERVER }}" \
              "sql-user=${{ secrets.SQL_USER }}" \
              "acrawardnominationazurecrio-acrawardnomination=$ACR_PASSWORD"
        done

    - name: Set Container App Secrets
      run: |
        # Get ACR admin password to inject as registry secret
        ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)

        for APP in ${{ env.CONTAINER_APP_EASTUS }} ${{ env.CONTAINER_APP_WESTUS }}; do
          az containerapp secret set \
            --name $APP \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --secrets \
              "gmail-app-password=${{ secrets.GMAIL_APP_PASSWORD }}" \
              "sql-database=${{ secrets.SQL_DATABASE }}" \
              "sql-password=${{ secrets.SQL_PASSWORD }}" \
              "sql-server=${{ secrets.SQL_SERVER }}" \
              "sql-user=${{ secrets.SQL_USER }}" \
              "acrawardnominationazurecrio-acrawardnomination=$ACR_PASSWORD"
        done

    - name: Update API_BASE_URL env var
      run: |
        # Fetch the real Front Door endpoint if it already exists (empty string on first deploy)
        FRONTDOOR_ENDPOINT=$(az afd endpoint show \
          --profile-name Award-Nomination-ADF \
          --endpoint-name award-nomination-api \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "hostName" -o tsv 2>/dev/null || echo "")

        for APP in ${{ env.CONTAINER_APP_EASTUS }} ${{ env.CONTAINER_APP_WESTUS }}; do
          az containerapp update \
            --name $APP \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --set-env-vars \
              "API_BASE_URL=https://${FRONTDOOR_ENDPOINT}" \
              "EMAIL_ACTION_SECRET_KEY=${{ secrets.EMAIL_ACTION_SECRET_KEY }}"
        done

    - name: Deploy to East US Container App
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_EASTUS }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Deploy to West US Container App
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_WESTUS }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Deployment Summary
      run: |
        FRONTDOOR_ENDPOINT=$(az afd endpoint show \
          --profile-name Award-Nomination-ADF \
          --endpoint-name award-nomination-api \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "hostName" -o tsv 2>/dev/null || echo "not yet deployed")

        echo "### Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed to:** East US & West US" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Front Door:** https://${FRONTDOOR_ENDPOINT}" >> $GITHUB_STEP_SUMMARY